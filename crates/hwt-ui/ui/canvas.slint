// Canvas Component
// Main editing area - placeholder for Bevy integration

import { Theme } from "theme.slint";

export component Canvas inherits Rectangle {
    in property <bool> show-grid: true;
    in property <float> zoom: 1.0;
    in property <float> pan-x: 0.0;
    in property <float> pan-y: 0.0;
    
    callback mouse-moved(float, float);
    callback mouse-pressed(float, float);
    callback mouse-released(float, float);
    callback zoom-changed(float);
    callback pan-changed(float, float);
    
    background: Theme.bg-primary;
    
    // Grid overlay (simplified - real grid would be in Bevy)
    if show-grid: Rectangle {
        // Grid pattern would be rendered by Bevy
    }
    
    // Placeholder content
    VerticalLayout {
        alignment: center;
        
        Text {
            text: "ðŸŽ¨";
            font-size: 64px;
            horizontal-alignment: center;
            color: Theme.text-disabled;
        }
        
        Text {
            text: "Canvas Area";
            font-size: 24px;
            horizontal-alignment: center;
            color: Theme.text-tertiary;
        }
        
        Text {
            text: "Bevy 3D renderer will be embedded here";
            font-size: 14px;
            horizontal-alignment: center;
            color: Theme.text-disabled;
        }
        
        Text {
            text: "Zoom: " + round(zoom * 100) + "%";
            font-size: 12px;
            horizontal-alignment: center;
            color: Theme.text-disabled;
        }
    }
    
    // Mouse interaction
    ta := TouchArea {
        moved => {
            root.mouse-moved(self.mouse-x / 1px, self.mouse-y / 1px);
        }
        
        pointer-event(e) => {
            if e.kind == PointerEventKind.down {
                root.mouse-pressed(self.mouse-x / 1px, self.mouse-y / 1px);
            } else if e.kind == PointerEventKind.up {
                root.mouse-released(self.mouse-x / 1px, self.mouse-y / 1px);
            }
        }
        
        scroll-event(e) => {
            // Zoom with scroll wheel
            if e.delta-y != 0px {
                root.zoom-changed(zoom * (1.0 + (e.delta-y / 100px)));
            }
            return accept;
        }
    }
}

export component PcbCanvasWithRulers inherits Rectangle {
    in property <bool> show-rulers: true;
    in property <int> units: 0; // 0=mm, 1=in
    in property <float> zoom: 1.0;
    in property <bool> show-grid: true;
    in property <float> pan-x: 0.0;
    in property <float> pan-y: 0.0;

    callback mouse-moved(float, float);
    callback mouse-pressed(float, float);
    callback mouse-released(float, float);
    callback zoom-changed(float);
    callback pan-changed(float, float);

    background: Theme.bg-primary;

    property <length> ruler-size: 24px;
    property <int> tick-step-px: 50;

    Rectangle {
        visible: show-rulers;
        x: ruler-size;
        y: 0px;
        width: parent.width - ruler-size;
        height: ruler-size;
        background: Theme.bg-secondary;
        clip: true;

        for i in 200: Rectangle {
            x: i * tick-step-px * 1px;
            y: ruler-size - (mod(i, 2) == 0 ? 10px : 6px);
            width: 1px;
            height: mod(i, 2) == 0 ? 10px : 6px;
            background: Theme.border-strong;
        }

        for i in 200: Text {
            visible: mod(i, 2) == 0;
            x: i * tick-step-px * 1px + 4px;
            y: 4px;
            text: units == 0 ? (round((i * tick-step-px) / zoom) + "") : (round(((i * tick-step-px) / zoom) / 25.4) + "");
            font-size: 10px;
            color: Theme.text-tertiary;
        }

        Text {
            x: 6px;
            y: 4px;
            text: units == 0 ? "mm" : "in";
            font-size: 10px;
            color: Theme.text-secondary;
        }
    }

    Rectangle {
        visible: show-rulers;
        x: 0px;
        y: ruler-size;
        width: ruler-size;
        height: parent.height - ruler-size;
        background: Theme.bg-secondary;
        clip: true;

        for i in 200: Rectangle {
            x: ruler-size - (mod(i, 2) == 0 ? 10px : 6px);
            y: i * tick-step-px * 1px;
            width: mod(i, 2) == 0 ? 10px : 6px;
            height: 1px;
            background: Theme.border-strong;
        }

        for i in 200: Text {
            visible: mod(i, 2) == 0;
            x: 2px;
            y: i * tick-step-px * 1px + 2px;
            text: units == 0 ? (round((i * tick-step-px) / zoom) + "") : (round(((i * tick-step-px) / zoom) / 25.4) + "");
            font-size: 10px;
            color: Theme.text-tertiary;
        }
    }

    Canvas {
        x: show-rulers ? ruler-size : 0px;
        y: show-rulers ? ruler-size : 0px;
        width: parent.width - (show-rulers ? ruler-size : 0px);
        height: parent.height - (show-rulers ? ruler-size : 0px);

        zoom: root.zoom;
        show-grid: root.show-grid;
        pan-x: root.pan-x;
        pan-y: root.pan-y;

        mouse-moved(x, y) => { root.mouse-moved(x, y); }
        mouse-pressed(x, y) => { root.mouse-pressed(x, y); }
        mouse-released(x, y) => { root.mouse-released(x, y); }
        zoom-changed(z) => { root.zoom-changed(z); }
        pan-changed(x, y) => { root.pan-changed(x, y); }
    }
}

export component Floating3DPanel inherits Rectangle {
    in property <bool> maximized: false;
    
    callback maximize-clicked;
    callback close-clicked;
    
    // Default size for floating mode (parent can override for maximized)
    min-width: 320px;
    min-height: 240px;
    
    background: Theme.bg-secondary;
    border-radius: maximized ? 0px : Theme.radius-lg;
    border-width: 1px;
    border-color: Theme.border-default;
    
    drop-shadow-blur: maximized ? 0px : 16px;
    drop-shadow-color: maximized ? transparent : #00000040;
    drop-shadow-offset-y: maximized ? 0px : 4px;
    
    VerticalLayout {
        // Header
        Rectangle {
            height: 32px;
            background: Theme.bg-tertiary;
            border-radius: Theme.radius-lg;
            
            HorizontalLayout {
                padding-left: Theme.spacing-md;
                padding-right: Theme.spacing-sm;
                
                Text {
                    text: "3D Preview";
                    color: Theme.text-primary;
                    font-size: 12px;
                    font-weight: 500;
                    vertical-alignment: center;
                }
                
                Rectangle { }
                
                // Maximize button
                Rectangle {
                    width: 24px;
                    height: 24px;
                    background: max-ta.has-hover ? Theme.bg-elevated : transparent;
                    border-radius: Theme.radius-sm;
                    
                    Image {
                        source: maximized ? @image-url("../assets/icons/restore.svg") : @image-url("../assets/icons/maximize.svg");
                        width: 14px;
                        height: 14px;
                        colorize: Theme.text-secondary;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                    }
                    
                    max-ta := TouchArea {
                        clicked => { root.maximize-clicked(); }
                    }
                }
                
                // Close button
                Rectangle {
                    width: 24px;
                    height: 24px;
                    background: close-ta.has-hover ? Theme.error.with-alpha(0.2) : transparent;
                    border-radius: Theme.radius-sm;
                    
                    Image {
                        source: @image-url("../assets/icons/close.svg");
                        width: 14px;
                        height: 14px;
                        colorize: close-ta.has-hover ? Theme.error : Theme.text-secondary;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                    }
                    
                    close-ta := TouchArea {
                        clicked => { root.close-clicked(); }
                    }
                }
            }
        }
        
        // 3D viewport placeholder
        Rectangle {
            background: #1a1a2e;
            
            VerticalLayout {
                alignment: center;
                
                Text {
                    text: "ðŸŽ²";
                    font-size: 48px;
                    horizontal-alignment: center;
                    color: Theme.text-disabled;
                }
                
                Text {
                    text: "3D Viewport";
                    font-size: 14px;
                    horizontal-alignment: center;
                    color: Theme.text-tertiary;
                }
                
                Text {
                    text: "Bevy renderer";
                    font-size: 11px;
                    horizontal-alignment: center;
                    color: Theme.text-disabled;
                }
            }
        }
    }
}
